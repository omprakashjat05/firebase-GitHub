<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=700, initial-scale=0.5, maximum-scale=1.0, user-scalable=yes" />
<title>üî• Admin Panel - Firebase + GitHub JSON Editor</title>

<style>
  /* Basic styles - similar theme to original panel */
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  body {
    font-family: 'Poppins', sans-serif;
    background: #0a0a0a;
    color: #f5f5f5;
    min-height: 100vh;
    margin: 0; padding: 0;
  }
  header {
    background: #1e1e1e;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #333;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  header h1 {
    color: #ffc107;
    font-size: 1.5em;
  }
  main {
    max-width: 1200px;
    margin: 30px auto;
    padding: 20px;
  }
  .card {
    background: #1e1e1e;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
    border: 1px solid #333;
  }
  h3 {
    color: #ffc107;
    margin-bottom: 15px;
  }
  .input-group {
    margin: 12px 0;
  }
  label {
    font-weight: 600;
    margin-bottom: 6px;
    display: block;
  }
  input[type="text"],
  input[type="password"],
  textarea,
  select {
    width: 100%;
    background: #2d2d2d;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    color: #f5f5f5;
    font-size: 14px;
    outline: none;
    font-family: 'Courier New', monospace;
    resize: vertical;
  }
  textarea {
    min-height: 300px;
    font-family: 'Courier New', monospace;
  }
  button {
    padding: 14px 25px;
    background: #ffc107;
    border: none;
    border-radius: 8px;
    color: #111;
    font-weight: 700;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #ffb300;
  }
  .login-section {
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
  }
  .login-card {
    background: #252525;
    border-radius: 12px;
    padding: 25px;
    width: 100%;
    max-width: 430px;
  }
  .login-card h4 {
    font-size: 1.2em;
    margin-bottom: 10px;
    color: #ffc107;
  }
  .divider {
    text-align: center;
    color: #aaa;
    margin: 30px 0;
    position: relative;
  }
  .divider::before, .divider::after {
    content: "";
    position: absolute;
    top: 50%;
    width: 45%;
    height: 1px;
    background: #333;
  }
  .divider::before { left: 0; }
  .divider::after { right: 0; }
  .user-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #ffc107;
  }
  .user-details {
    text-align: right;
  }
  .user-name {
    font-weight: 600;
    color: #ffc107;
  }
  .user-email {
    font-size: 0.85em;
    color: #aaa;
  }
  .logout-btn {
    background: #e53935;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
  .logout-btn:hover {
    background: #b71c1c;
  }
  .tab {
    display: inline-block;
    padding: 10px 18px;
    cursor: pointer;
    background: #2d2d2d;
    margin-right: 8px;
    color: #aaa;
    border-radius: 8px 8px 0 0;
    font-weight: 600;
  }
  .tab.active {
    background: #ffc107;
    color: #111;
  }
  .tab-content {
    display: none;
    background: #252525;
    border: 1px solid #333;
    border-top: none;
    border-radius: 0 0 12px 12px;
    padding: 20px;
  }
  .tab-content.active {
    display: block;
  }
  .empty-state {
    text-align: center;
    color: #666;
    margin-top: 30px;
  }
  .repo-list,
  .repo-list div {
    cursor: pointer;
  }
  .repo-list div:hover,
  .repo-list .active {
    color: #ffc107;
  }
  .status-bar {
    margin-bottom: 15px;
    color: #aaa;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .fab {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #ffc107;
    border-radius: 50%;
    border: none;
    padding: 0;
    font-size: 36px;
    width: 64px;
    height: 64px;
    box-shadow: 0 6px 20px rgba(255,193,7,0.6);
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #111;
  }
  .fab:hover {
    background: #ffb300;
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

</head>

<body>
  <header>
    <h1>üî• Admin Panel</h1>
    <div class="user-info" id="userInfo" style="display:none;">
      <div class="user-details">
        <div class="user-name" id="userName"></div>
        <div class="user-email" id="userEmail"></div>
      </div>
      <img class="user-avatar" id="userAvatar" src="" alt="Avatar" />
      <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
    </div>
  </header>

  <main>
    <!-- Login Section -->
    <section id="loginSection" class="card">
      <h3>üîê Choose Login Method</h3>
      <div class="login-section">
        <!-- Firebase Google Login -->
        <div class="login-card">
          <h4>üî• Firebase Google Login</h4>
          <button id="firebaseGoogleBtn" style="background:#4285f4;color:#fff;padding:14px;font-weight:700;border-radius:8px;cursor:pointer;width:100%;">üåê Login with Google</button>
          <p style="margin-top:16px; font-size: 0.9em; color:#aaa;">
            Only users with authorized email <b>www.webomprakashjat@gmail.com</b> can save.
          </p>
        </div>

        <!-- Divider -->
        <div style="align-self:center; color:#666; font-weight: bold; font-size: 24px;">OR</div>

        <!-- GitHub Token Login -->
        <div class="login-card">
          <h4>üêô GitHub Token Login</h4>
          <label>GitHub Personal Access Token (repo permission)</label>
          <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxx" style="margin-bottom:12px;">
          <button id="githubLoginBtn" style="background:#238636;color:#fff;padding:14px;font-weight:700;border-radius:8px;cursor:pointer;width:100%;">üêô Connect GitHub</button>
          <p style="margin-top:16px; font-size: 0.9em; color:#aaa;">
            Generate token at <a href="https://github.com/settings/tokens" target="_blank" style="color:#ffc107;">GitHub tokens settings</a>.
          </p>
        </div>
      </div>
    </section>

    <!-- Main Panel -->
    <section id="mainPanel" class="card" style="display:none;">
      <div class="status-bar" id="topStatus">‚ö° Not connected</div>

      <!-- Source info -->
      <div style="margin-bottom: 16px; color:#aaa;">
        Data Source: <span id="dataSourceInfo" style="font-weight: 600;"></span>
      </div>

      <!-- GitHub repo and file selection -->
      <div id="githubSection" style="display:none; margin-bottom: 24px;">
        <h3>Select Repository</h3>
        <div id="repoList" style="max-height:150px;overflow-y:auto; border: 1px solid #333; padding: 5px;"></div>
        <h3 style="margin-top:20px;">Select JSON File</h3>
        <select id="fileSelect" style="background:#2d2d2d; border:1px solid #333; padding:10px; color:#f5f5f5; width:100%; border-radius:8px;">
          <option value="">-- Select a JSON file --</option>
        </select>
        <button id="loadGithubJsonBtn" style="margin-top: 12px; width: 100%;">Load JSON</button>
      </div>

      <!-- Firebase section description -->
      <div id="firebaseSection" style="display:none; margin-bottom: 24px;">
        <h3 style="color:#ffc107;">Firebase Realtime Database</h3>
        <p>Editing JSON stored at root level of your Firebase Realtime Database (based on your setup).</p>
        <p>Only editable by authorized Google user (<b>www.webomprakashjat@gmail.com</b>).</p>
        <button id="loadFirebaseJsonBtn" style="width: 100%;">Load JSON from Firebase</button>
      </div>

      <!-- Tab buttons -->
      <div style="margin-top: 12px;">
        <span class="tab active" data-tab="keysTab">üîë Keys View</span>
        <span class="tab" data-tab="jsonTab">üìù Raw JSON Editor</span>
      </div>

      <!-- Keys View -->
      <div id="keysTab" class="tab-content active" style="margin-top: 15px;">
        <div id="keysListContainer" style="max-height: 480px; overflow-y: auto; border: 1px solid #333; border-radius: 8px; padding: 10px;"></div>
        <button class="fab" id="addKeyBtn" title="Add New Key">+</button>
      </div>

      <!-- Raw JSON Editor -->
      <div id="jsonTab" class="tab-content" style="margin-top: 15px;">
        <textarea id="rawJsonEditor" placeholder="Loading JSON..." style="width: 100%; height: 400px; background:#2d2d2d; color:#f5f5f5; border-radius:8px; padding:15px; font-family: 'Courier New', monospace;"></textarea>
        <div style="margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap;">
          <button id="saveJsonBtn">üíæ Save JSON</button>
          <button id="formatJsonBtn">‚ú® Format JSON</button>
          <button id="resetJsonBtn">üîÑ Reset</button>
        </div>
      </div>
    </section>

  <!-- Add/Edit Key Modal -->
  <div id="keyModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:2000;">
    <div style="background:#1e1e1e; padding:25px; border-radius:12px; max-width:400px; width: 90%;">
      <h3 style="color:#ffc107; margin-bottom:20px;" id="modalTitle">Add Key</h3>
      <label>Device ID</label>
      <input type="text" id="modalDeviceId" style="width:100%; padding:10px; margin-bottom:12px; background:#2d2d2d; border:1px solid #333; color:#f5f5f5; border-radius:8px;">
        
      <label>License Key</label>
      <input type="text" id="modalKey" style="width:100%; padding:10px; margin-bottom:12px; background:#2d2d2d; border:1px solid #333; color:#f5f5f5; border-radius:8px;">

      <label>Expiry Date (dd-mm-yyyy)</label>
      <input type="text" id="modalExpiry" placeholder="dd-mm-yyyy" style="width:100%; padding:10px; margin-bottom:12px; background:#2d2d2d; border:1px solid #333; color:#f5f5f5; border-radius:8px;">

      <label>User Name</label>
      <input type="text" id="modalUserName" style="width:100%; padding:10px; margin-bottom:12px; background:#2d2d2d; border:1px solid #333; color:#f5f5f5; border-radius:8px;">

      <label><input type="checkbox" id="modalAllowOffline" /> Allow Offline</label>

      <div style="margin-top: 20px; display:flex; justify-content: space-between;">
        <button id="modalSaveBtn" style="flex: 1; margin-right: 10px;">üíæ Save</button>
        <button id="modalCancelBtn" style="flex: 1; background:#e53935; color:white;">Cancel</button>
      </div>
    </div>
  </div>

  </main>

<script>
/** Global State Variables **/
let currentProvider = null; // 'firebase' or 'github'
let firebaseUser = null;
let githubToken = null;

let currentData = null;      // JSON data object/array loaded
let githubRepos = [];        // GitHub repos list
let githubSelectedRepo = null;
let githubSelectedFile = null;
let githubFileSha = null;

////////////////////////////
// --- Firebase Setup --- //
////////////////////////////

// Put your Firebase config here, replace placeholders:
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

//////////////////////////////
// --- DOM Elements --- //
//////////////////////////////

const loginSection = document.getElementById('loginSection');
const mainPanel = document.getElementById('mainPanel');
const userInfo = document.getElementById('userInfo');
const userNameDisplay = document.getElementById('userName');
const userEmailDisplay = document.getElementById('userEmail');
const userAvatarDisplay = document.getElementById('userAvatar');
const logoutBtn = document.getElementById('logoutBtn');

const firebaseGoogleBtn = document.getElementById('firebaseGoogleBtn');

const githubTokenInput = document.getElementById('githubToken');
const githubLoginBtn = document.getElementById('githubLoginBtn');
const repoListDiv = document.getElementById('repoList');
const fileSelectDropdown = document.getElementById('fileSelect');
const loadGithubJsonBtn = document.getElementById('loadGithubJsonBtn');
const githubSection = document.getElementById('githubSection');
const firebaseSection = document.getElementById('firebaseSection');
const topStatus = document.getElementById('topStatus');
const dataSourceInfo = document.getElementById('dataSourceInfo');

const keysTabBtn = document.querySelector('[data-tab="keysTab"]');
const jsonTabBtn = document.querySelector('[data-tab="jsonTab"]');
const keysTabContent = document.getElementById('keysTab');
const jsonTabContent = document.getElementById('jsonTab');

const rawJsonEditor = document.getElementById('rawJsonEditor');
const saveJsonBtn = document.getElementById('saveJsonBtn');
const formatJsonBtn = document.getElementById('formatJsonBtn');
const resetJsonBtn = document.getElementById('resetJsonBtn');

const keysListContainer = document.getElementById('keysListContainer');
const addKeyBtn = document.getElementById('addKeyBtn');

const keyModal = document.getElementById('keyModal');
const modalTitle = document.getElementById('modalTitle');
const modalDeviceId = document.getElementById('modalDeviceId');
const modalKey = document.getElementById('modalKey');
const modalExpiry = document.getElementById('modalExpiry');
const modalUserName = document.getElementById('modalUserName');
const modalAllowOffline = document.getElementById('modalAllowOffline');
const modalSaveBtn = document.getElementById('modalSaveBtn');
const modalCancelBtn = document.getElementById('modalCancelBtn');

//////////////////////////////
// --- Helper Functions --- //
//////////////////////////////

function showStatus(msg, isError = false) {
  topStatus.textContent = msg;
  topStatus.style.color = isError ? '#e53935' : '#aaa';
}

function resetStatus() {
  topStatus.textContent = '‚ö° Ready';
  topStatus.style.color = '#aaa';
}

function showSection(section) {
  // Hide both disjoint sections
  githubSection.style.display = 'none';
  firebaseSection.style.display = 'none';

  if (section === 'firebase') firebaseSection.style.display = 'block';
  else if (section === 'github') githubSection.style.display = 'block';
}

function showUserInfo(user) {
  userInfo.style.display = 'flex';
  loginSection.style.display = 'none';
  mainPanel.style.display = 'block';

  // Show user data
  userNameDisplay.textContent = user.displayName || user.email || user.login || 'User';
  userEmailDisplay.textContent = user.email || ('@' + user.login || '');
  userAvatarDisplay.src = user.photoURL || user.avatar_url || 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png';
}

function clearUserInfo() {
  userInfo.style.display = 'none';
  loginSection.style.display = 'block';
  mainPanel.style.display = 'none';

  userNameDisplay.textContent = '';
  userEmailDisplay.textContent = '';
  userAvatarDisplay.src = '';
  resetStatus();
}

function base64Decode(s) {
  return decodeURIComponent(escape(atob(s)));
}

function base64Encode(s) {
  return btoa(unescape(encodeURIComponent(s)));
}

// Validate date dd-mm-yyyy (basic)
function validateDate(dateStr) {
  const regex = /^\d{2}-\d{2}-\d{4}$/;
  if(!regex.test(dateStr)) return false;
  const [dd, mm, yyyy] = dateStr.split('-').map(Number);
  if(yyyy < 2000 || mm < 1 || mm > 12 || dd < 1 || dd > 31) return false;
  return true;
}

// Is expired? Date format dd-mm-yyyy
function isExpired(dateStr) {
  if(!dateStr) return false;
  if(!validateDate(dateStr)) return false;
  const [dd, mm, yyyy] = dateStr.split('-').map(Number);
  const expDate = new Date(yyyy, mm -1, dd);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  return expDate < today;
}

//////////////////////////////////////
// --- Github Functions --- //
//////////////////////////////////////

async function githubApiGet(url) {
  const resp = await fetch(url, {
    headers: {
      'Authorization': 'token ' + githubToken,
      'Accept': 'application/vnd.github.v3+json',
    }
  });
  if(!resp.ok) throw new Error('GitHub API error: ' + resp.statusText);
  return resp.json();
}

async function githubApiPut(url, body) {
  const resp = await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': 'token ' + githubToken,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  if(!resp.ok) throw new Error('GitHub API PUT error: ' + resp.statusText);
  return resp.json();
}

async function fetchGitHubRepos() {
  showStatus('‚è≥ Loading GitHub repositories...');
  githubRepos = await githubApiGet('https://api.github.com/user/repos?per_page=100&sort=updated');
  showStatus(`‚úÖ Loaded ${githubRepos.length} repos`);
  displayGitHubRepos();
}

function displayGitHubRepos() {
  repoListDiv.innerHTML = '';
  githubRepos.forEach(repo => {
    const div = document.createElement('div');
    div.textContent = repo.name + (repo.private ? ' üîí' : ' üåç');
    div.style.padding = '6px';
    div.style.borderBottom = '1px solid #333';
    div.style.cursor = 'pointer';
    div.title = repo.full_name;
    div.onclick = () => {
      githubSelectedRepo = repo;
      fetchGitHubJsonFiles(repo);
      // Highlight selected
      Array.from(repoListDiv.children).forEach(c => c.style.color = '#aaa');
      div.style.color = '#ffc107';
    };
    repoListDiv.appendChild(div);
  });
}

async function fetchGitHubJsonFiles(repo) {
  showStatus(`‚è≥ Fetching files for ${repo.name}...`);
  const branch = repo.default_branch || 'main';
  const treeData = await githubApiGet(`https://api.github.com/repos/${repo.full_name}/git/trees/${branch}?recursive=1`);
  const jsonFiles = treeData.tree.filter(f => f.path.endsWith('.json'));
  // Populate select
  fileSelectDropdown.innerHTML = '<option value="">-- Select a JSON file --</option>';
  jsonFiles.forEach(file => {
    const option = document.createElement('option');
    option.value = file.path;
    option.textContent = file.path;
    fileSelectDropdown.appendChild(option);
  });
  showStatus(`‚úÖ Found ${jsonFiles.length} JSON files`);
  githubSelectedFile = null;
}

async function loadGitHubJson() {
  if (!githubSelectedRepo) return alert('Please select a repository!');
  const path = fileSelectDropdown.value;
  if (!path) return alert('Please select a JSON file!');
  showStatus('‚è≥ Loading JSON file content...');
  try {
    const contentData = await githubApiGet(`https://api.github.com/repos/${githubSelectedRepo.full_name}/contents/${path}`);
    githubFileSha = contentData.sha;
    const jsonStr = base64Decode(contentData.content);
    currentData = JSON.parse(jsonStr);
    updateUIAfterDataLoad('GitHub repo: ' + githubSelectedRepo.name + '/' + path);
  } catch(error) {
    alert('GitHub load error: ' + error.message);
    showStatus('Error loading GitHub file', true);
  }
}

async function saveGitHubJson() {
  if (!githubSelectedRepo || !githubSelectedFile) return alert('No GitHub repo/file selected!');
  showStatus('‚è≥ Saving JSON to GitHub...');
  try {
    const contentEncoded = base64Encode(JSON.stringify(currentData, null, 2));
    const commitMsg = `Update keys via Admin Panel (${new Date().toLocaleString()})`;
    const res = await githubApiPut(`https://api.github.com/repos/${githubSelectedRepo.full_name}/contents/${githubSelectedFile}`, {
      message: commitMsg,
      content: contentEncoded,
      sha: githubFileSha
    });
    githubFileSha = res.content.sha;
    showStatus('‚úÖ JSON saved to GitHub!');
    updateUIAfterDataLoad(`GitHub repo: ${githubSelectedRepo.name} / ${githubSelectedFile}`);
  } catch(err) {
    alert('GitHub save error: ' + err.message);
    showStatus('Error saving GitHub file', true);
  }
}

//////////////////////////////////////
// --- Firebase Functions --- //
//////////////////////////////////////

// Firebase authorized email as per your rules
const AUTHORIZED_EMAIL = "www.webomprakashjat@gmail.com";

firebaseGoogleBtn.onclick = async () => {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await auth.signInWithPopup(provider);
    const user = result.user;
    if (!user) throw new Error('No user info returned');
    if (user.email !== AUTHORIZED_EMAIL) {
      alert(`Unauthorized user email: ${user.email}\nOnly ${AUTHORIZED_EMAIL} can save data.`);
    }
    googleLoginSuccess(user);
  } catch(err) {
    alert('Firebase login error: ' + err.message);
  }
};

auth.onAuthStateChanged(user => {
  if(user) {
    googleLoginSuccess(user);
  } else {
    clearUserInfo();
  }
});

function googleLoginSuccess(user) {
  firebaseUser = user;
  currentProvider = 'firebase';
  githubToken = null;
  githubSelectedRepo = null;
  githubSelectedFile = null;
  githubRepos = [];
  githubFileSha = null;
  showUserInfo(user);
  showSection('firebase');
  dataSourceInfo.textContent = 'Firebase Realtime Database (root)';
  resetStatus();
  rawJsonEditor.value = '';
  currentData = null;
  keysListContainer.innerHTML = '';
}

async function loadFirebaseJson() {
  if (!firebaseUser) return alert('Not logged in');
  showStatus('‚è≥ Loading JSON from Firebase...');
  try {
    const snapshot = await db.ref('/').get(); // root path per screenshot
    const data = snapshot.val() || {};
    currentData = data;
    updateUIAfterDataLoad('Firebase Realtime Database (root)');
  } catch(err) {
    alert('Firebase load error: ' + err.message);
    showStatus('Error loading Firebase data', true);
  }
}

async function saveFirebaseJson() {
  if (!firebaseUser) return alert('Not logged in');
  if (firebaseUser.email !== AUTHORIZED_EMAIL) {
    return alert(`Unauthorized email: ${firebaseUser.email} cannot save data.`);
  }
  showStatus('‚è≥ Saving JSON to Firebase...');
  try {
    await db.ref('/').set(currentData);
    showStatus('‚úÖ JSON saved to Firebase!');
    updateUIAfterDataLoad('Firebase Realtime Database (root)');
  } catch(err) {
    alert('Firebase save error: ' + err.message);
    showStatus('Error saving Firebase data', true);
  }
}

//////////////////////////////
// --- Shared UI Handlers --- //
//////////////////////////////

function updateUIAfterDataLoad(sourceInfo) {
  resetStatus();
  dataSourceInfo.textContent = sourceInfo;
  // Update raw JSON editor
  rawJsonEditor.value = JSON.stringify(currentData, null, 2);
  // Update keys list UI
  displayKeysList();
}

// Display keys/licenses list (supports array or object)
function displayKeysList() {
  keysListContainer.innerHTML = '';
  if(!currentData) {
    keysListContainer.innerHTML = `<div class="empty-state">No JSON data loaded.</div>`;
    return;
  }
  let keysArray = [];
  if (Array.isArray(currentData)) {
    keysArray = currentData;
  } else if (typeof currentData === 'object') {
    keysArray = Object.keys(currentData).map(k => {
      const v = currentData[k];
      return {
        device_id: v.device_id || k,
        key: v.key || '',
        expirydate: v.expirydate || '',
        user: v.user || '',
        Allowoffline: v.Allowoffline || false
      };
    });
  } else {
    keysListContainer.innerHTML = `<div class="empty-state">Invalid JSON format.</div>`;
    return;
  }
  if(keysArray.length === 0) {
    keysListContainer.innerHTML = `<div class="empty-state">Empty keys list.</div>`;
    return;
  }
  keysArray.forEach((item, idx) => {
    const isExpiredVal = isExpired(item.expirydate);
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <p><b>#${idx+1} Device:</b> ${item.device_id}</p>
      <p><b>User:</b> ${item.user}</p>
      <p><b>Key:</b> ${item.key}</p>
      <p><b>Expiry:</b> ${item.expirydate} ${isExpiredVal ? '‚ö†Ô∏è Expired' : ''}</p>
      <p><b>Offline:</b> ${item.Allowoffline ? 'Yes' : 'No'}</p>
      <div class="btn-group" style="margin-top:8px;">
        <button class="btn-update" onclick="editKey(${idx})">‚úèÔ∏è Update</button>
        <button class="btn-delete" onclick="deleteKey(${idx})">üóë Delete</button>
      </div>
      <hr style="margin:15px 0; border-color:#333;">
    `;
    keysListContainer.appendChild(div);
  });
}

let editingKeyIndex = null;

function editKey(index) {
  editingKeyIndex = index;
  let keyObj = null;
  if(Array.isArray(currentData)) {
    keyObj = currentData[index];
  } else if(typeof currentData === 'object') {
    const keys = Object.keys(currentData);
    if(index < keys.length) keyObj = currentData[keys[index]];
  }
  if(!keyObj) return alert('Invalid selection!');
  // Show modal with key info
  modalTitle.textContent = '‚úèÔ∏è Update License Key';
  modalDeviceId.value = keyObj.device_id || '';
  modalKey.value = keyObj.key || '';
  modalExpiry.value = keyObj.expirydate || '';
  modalUserName.value = keyObj.user || '';
  modalAllowOffline.checked = !!keyObj.Allowoffline;
  keyModal.style.display = 'flex';
}

function deleteKey(index) {
  if(!confirm('Delete this license key?')) return;
  if(Array.isArray(currentData)) {
    currentData.splice(index, 1);
  } else if(typeof currentData === 'object') {
    let keys = Object.keys(currentData);
    if(index < keys.length) {
      delete currentData[keys[index]];
    }
  }
  displayKeysList();
  updateRawJsonEditor();
}

function updateRawJsonEditor() {
  rawJsonEditor.value = JSON.stringify(currentData, null, 2);
}

// Add new key modal
addKeyBtn.onclick = () => {
  editingKeyIndex = null;
  modalTitle.textContent = '‚ûï Add License Key';
  modalDeviceId.value = '';
  modalKey.value = '';
  modalExpiry.value = '';
  modalUserName.value = '';
  modalAllowOffline.checked = false;
  keyModal.style.display = 'flex';
};

modalCancelBtn.onclick = () => {
  keyModal.style.display = 'none';
};

modalSaveBtn.onclick = () => {
  const deviceId = modalDeviceId.value.trim();
  const key = modalKey.value.trim();
  const expiry = modalExpiry.value;
  const user = modalUserName.value.trim();
  const allow = modalAllowOffline.checked;

  if(!deviceId || !key || !expiry || !user) {
    return alert('Fill all fields!');
  }
  if(!validateDate(expiry)) {
    return alert('Expiry date must be in dd-mm-yyyy format!');
  }

  let newEntry = {device_id: deviceId, key, expirydate: expiry, user, Allowoffline: allow};

  if(Array.isArray(currentData)) {
    if(editingKeyIndex !== null) {
      currentData[editingKeyIndex] = newEntry;
    } else {
      currentData.push(newEntry);
    }
  } else if(typeof currentData === 'object') {
    // Use device_id as key
    currentData[deviceId] = newEntry;
  } else {
    alert('Invalid data format, cannot add key.');
    return;
  }

  updateRawJsonEditor();
  displayKeysList();
  keyModal.style.display = 'none';
};


//////////////////////////////
// --- Raw JSON Editor Actions --- //
//////////////////////////////

saveJsonBtn.onclick = async () => {
  try {
    const parsed = JSON.parse(rawJsonEditor.value);
    currentData = parsed;
  } catch(e) {
    return alert('Invalid JSON input!');
  }
  showStatus('Saving JSON...');
  if (currentProvider === 'github') {
    await saveGitHubJson();
  } else if (currentProvider === 'firebase') {
    await saveFirebaseJson();
  }
  showStatus('JSON saved!');
  displayKeysList();
};

formatJsonBtn.onclick = () => {
  try {
    const parsed = JSON.parse(rawJsonEditor.value);
    rawJsonEditor.value = JSON.stringify(parsed, null, 2);
    alert('Formatted JSON!');
  } catch(e) {
    alert('Invalid JSON!');
  }
};

resetJsonBtn.onclick = () => {
  if(!currentData) return;
  if(confirm('Reset editor to last loaded data?')) {
    rawJsonEditor.value = JSON.stringify(currentData, null, 2);
  }
};

//////////////////////////////
// --- Tab Control --- //
//////////////////////////////

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const tabName = tab.dataset.tab;
    keysTabContent.classList.remove('active');
    jsonTabContent.classList.remove('active');
    if(tabName === 'keysTab') keysTabContent.classList.add('active');
    if(tabName === 'jsonTab') jsonTabContent.classList.add('active');
  });
});

//////////////////////////////
// --- GitHub Login --- //
//////////////////////////////

githubLoginBtn.onclick = async () => {
  const token = githubTokenInput.value.trim();
  if(!token) return alert('Enter your GitHub token!');
  if(!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
    return alert('Token should start with ghp_ or github_pat_');
  }
  githubToken = token;
  currentProvider = 'github';
  firebaseUser = null;
  showStatus('Verifying GitHub token and loading repos...');
  githubSelectedRepo = null;
  githubSelectedFile = null;
  githubRepos = [];
  githubFileSha = null;
  showUserInfo({ login: 'GitHub User', avatar_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png' });
  showSection('github');
  dataSourceInfo.textContent = 'GitHub Repositories';

  try {
    await fetchGitHubRepos();
  } catch(e) {
    alert('GitHub error: ' + e.message);
    clearUserInfo();
    githubToken = null;
  }
};

loadGithubJsonBtn.onclick = async () => {
  await loadGitHubJson();
};

//////////////////////////////
// --- Firebase Load Button --- //
//////////////////////////////

const loadFirebaseJsonBtn = document.getElementById('loadFirebaseJsonBtn');
loadFirebaseJsonBtn.onclick = async () => {
  await loadFirebaseJson();
};

//////////////////////////////
// --- Logout --- //
//////////////////////////////

logoutBtn.onclick = async () => {
  if(currentProvider === 'firebase') {
    await auth.signOut();
    firebaseUser = null;
  }
  // Clear GitHub token/login
  githubToken = null;
  githubSelectedRepo = null;
  githubSelectedFile = null;
  githubRepos = [];
  githubFileSha = null;
  currentProvider = null;
  currentData = null;
  clearUserInfo();
  showSection(null);
  rawJsonEditor.value = '';
  keysListContainer.innerHTML = '';
  githubTokenInput.value = '';
};

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üî• Firebase Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Orbitron:wght@400;700&family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #f5e6d3;
      --bg-secondary: #e8d5c4;
      --bg-card: #fff9f0;
      --bg-card-expired: linear-gradient(145deg, #ffe5e5 0%, #ffd6d6 100%);
      --bg-input: #ffffff;
      --accent: #ff6b35;
      --accent-hover: #e55a2b;
      --accent-light: rgba(255, 107, 53, 0.15);
      --text-primary: #333;
      --text-secondary: #666;
      --border: #d4c4b0;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --card-radius: 12px;
      --font-main: 'Poppins', sans-serif;
      --font-mono: 'Courier New', monospace;
      --header-bg: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      --card-shadow: 0 2px 8px rgba(0,0,0,0.05);
      --card-border: 4px solid var(--accent);
      --expired-border: 4px solid var(--danger);
    }

    /* ===== STARTER THEME (Warm Cream + Firebase Orange) ===== */
    [data-theme="starter"] {
      --bg-primary: #f5e6d3;
      --bg-secondary: #e8d5c4;
      --bg-card: #fff9f0;
      --accent: #ff6b35;
      --accent-hover: #e55a2b;
      --border: #d4c4b0;
      --header-bg: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      --card-radius: 12px;
      --font-main: 'Poppins', sans-serif;
    }

    /* ===== STARTER PRO THEME (Dark Gold) ===== */
    [data-theme="starter-pro"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #0d0d0d;
      --bg-card: #252525;
      --bg-card-expired: linear-gradient(145deg, #3d1a1a 0%, #2d1515 100%);
      --accent: #ffc107;
      --accent-hover: #ffb300;
      --accent-light: rgba(255, 193, 7, 0.15);
      --text-primary: #f5f5f5;
      --text-secondary: #aaa;
      --border: #333;
      --header-bg: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      --card-shadow: 0 4px 15px rgba(255, 193, 7, 0.1);
      --card-radius: 10px;
      --font-main: 'Poppins', sans-serif;
    }

    [data-theme="starter-pro"] .header h1 { color: #111; }
    [data-theme="starter-pro"] .header-logo { fill: #111; }
    [data-theme="starter-pro"] .header-btn { background: #111; color: #ffc107; }
    [data-theme="starter-pro"] .user-name { color: #111; }
    [data-theme="starter-pro"] .user-username { color: #333; }
    [data-theme="starter-pro"] .device-card { border-left: 4px solid #ffc107; background: linear-gradient(145deg, #252525 0%, #1f1f1f 100%); }
    [data-theme="starter-pro"] .device-id { color: #ffc107; }
    [data-theme="starter-pro"] .key-value { background: rgba(255,193,7,0.15); color: #ffc107; }
    [data-theme="starter-pro"] .json-editor { background: #0a0a0a; border-color: #ffc107; }

    /* ===== STARTER MAX THEME (Neon Cyber) ===== */
    [data-theme="starter-max"] {
      --bg-primary: #0a0e1a;
      --bg-secondary: #050810;
      --bg-card: #0d1220;
      --bg-card-expired: linear-gradient(145deg, #2a1a2a 0%, #1a1020 100%);
      --accent: #00f5ff;
      --accent-hover: #00d4e0;
      --accent-light: rgba(0, 245, 255, 0.1);
      --text-primary: #e0f7ff;
      --text-secondary: #7fdbff;
      --border: #1a3a4a;
      --header-bg: linear-gradient(135deg, #0d1220 0%, #1a2a3a 100%);
      --card-shadow: 0 0 20px rgba(0, 245, 255, 0.15);
      --card-radius: 5px;
      --font-main: 'Orbitron', sans-serif;
      --font-mono: 'Share Tech Mono', monospace;
    }

    [data-theme="starter-max"] body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: 
        linear-gradient(90deg, rgba(0,245,255,0.03) 1px, transparent 1px),
        linear-gradient(rgba(0,245,255,0.03) 1px, transparent 1px);
      background-size: 30px 30px;
      pointer-events: none;
      z-index: -1;
    }

    [data-theme="starter-max"] .header { border-bottom: 2px solid #00f5ff; box-shadow: 0 0 30px rgba(0,245,255,0.2); }
    [data-theme="starter-max"] .device-card { 
      border: 1px solid #00f5ff; 
      border-left: 4px solid #00f5ff;
      box-shadow: 0 0 15px rgba(0,245,255,0.1), inset 0 0 20px rgba(0,245,255,0.03);
      background: linear-gradient(145deg, #0d1220 0%, #0a0e18 100%);
    }
    [data-theme="starter-max"] .device-card.expired { border-color: #ff0080; box-shadow: 0 0 15px rgba(255,0,128,0.2); }
    [data-theme="starter-max"] .device-id { color: #00f5ff; text-shadow: 0 0 10px rgba(0,245,255,0.5); }
    [data-theme="starter-max"] .key-value { background: rgba(0,245,255,0.1); color: #00f5ff; border: 1px solid rgba(0,245,255,0.3); }
    [data-theme="starter-max"] .stats-card { background: linear-gradient(135deg, #0d1220 0%, #1a2a3a 100%); border: 1px solid #00f5ff; box-shadow: 0 0 25px rgba(0,245,255,0.2); }
    [data-theme="starter-max"] .expired-badge { background: #ff0080; box-shadow: 0 0 10px rgba(255,0,128,0.5); }
    [data-theme="starter-max"] .json-editor { background: #050810; border: 1px solid #00f5ff; color: #00f5ff; }
    [data-theme="starter-max"] .sub-tabs, [data-theme="starter-max"] .filter-tab, [data-theme="starter-max"] .search-bar { border: 1px solid #1a3a4a; }
    [data-theme="starter-max"] .sub-tab.active { background: #00f5ff; color: #0a0e1a; }

    /* ===== STARTER DEVELOPER THEME (Matrix Green) ===== */
    [data-theme="starter-developer"] {
      --bg-primary: #0a0a0a;
      --bg-secondary: #050505;
      --bg-card: #0f0f0f;
      --bg-card-expired: linear-gradient(145deg, #1a0a0a 0%, #150505 100%);
      --accent: #00ff41;
      --accent-hover: #00cc33;
      --accent-light: rgba(0, 255, 65, 0.1);
      --text-primary: #00ff41;
      --text-secondary: #00aa2a;
      --border: #00ff41;
      --header-bg: linear-gradient(135deg, #0a0a0a 0%, #0f0f0f 100%);
      --card-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
      --card-radius: 0px;
      --font-main: 'Share Tech Mono', monospace;
      --font-mono: 'Share Tech Mono', monospace;
    }

    [data-theme="starter-developer"] body::before {
      content: ">";
      position: fixed;
      bottom: 10px;
      left: 10px;
      color: #00ff41;
      font-family: 'Share Tech Mono', monospace;
      animation: blink 1s infinite;
      pointer-events: none;
      z-index: 1;
    }

    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }

    [data-theme="starter-developer"] .header { border-bottom: 1px solid #00ff41; }
    [data-theme="starter-developer"] .device-card { 
      border: 1px solid #00ff41; 
      border-left: 3px solid #00ff41;
      background: #0a0a0a;
    }
    [data-theme="starter-developer"] .device-card.expired { border-color: #ff0000; }
    [data-theme="starter-developer"] .device-id { color: #00ff41; }
    [data-theme="starter-developer"] .user-name-card, [data-theme="starter-developer"] .expiry-text { color: #00aa2a; }
    [data-theme="starter-developer"] .key-value { background: #050505; color: #00ff41; border: 1px solid #00ff41; }
    [data-theme="starter-developer"] .stats-card { background: #0a0a0a; border: 1px solid #00ff41; }
    [data-theme="starter-developer"] .expired-badge { background: #ff0000; }
    [data-theme="starter-developer"] .sub-tabs, [data-theme="starter-developer"] .search-bar, [data-theme="starter-developer"] .filter-tab { 
      background: #0a0a0a; border: 1px solid #00ff41; 
    }
    [data-theme="starter-developer"] .sub-tab.active, [data-theme="starter-developer"] .filter-tab.active { background: #00ff41; color: #0a0a0a; }
    [data-theme="starter-developer"] .fab-button { background: #00ff41; }
    [data-theme="starter-developer"] .fab-button svg { color: #0a0a0a; }
    [data-theme="starter-developer"] .bottom-nav { background: #0a0a0a; border-top: 1px solid #00ff41; }
    [data-theme="starter-developer"] .json-editor { background: #000; border: 1px solid #00ff41; }

    /* ===== FIREBASE THEME (Orange Fire) ===== */
    [data-theme="firebase"] {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #0f3460;
      --bg-card-expired: linear-gradient(145deg, #4a1a1a 0%, #3a1010 100%);
      --accent: #ff6b35;
      --accent-hover: #f7931e;
      --accent-light: rgba(255, 107, 53, 0.15);
      --text-primary: #eee;
      --text-secondary: #aaa;
      --border: #ff6b35;
      --header-bg: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      --card-shadow: 0 4px 20px rgba(255, 107, 53, 0.2);
      --card-radius: 12px;
      --font-main: 'Poppins', sans-serif;
    }

    [data-theme="firebase"] .header h1 { color: #fff; }
    [data-theme="firebase"] .device-card { 
      border-left: 4px solid #ff6b35; 
      background: linear-gradient(145deg, #0f3460 0%, #16213e 100%);
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.1);
    }
    [data-theme="firebase"] .device-id { color: #ff6b35; }
    [data-theme="firebase"] .key-value { background: rgba(255,107,53,0.15); color: #ff6b35; }
    [data-theme="firebase"] .stats-card { background: linear-gradient(135deg, #0f3460 0%, #16213e 100%); border: 1px solid #ff6b35; }

    body { font-family: var(--font-main); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; padding-bottom: 80px; }

    .header {
      background: var(--header-bg); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 100;
    }
    .header h1 { font-size: 15px; font-weight: 700; color: white; display: flex; align-items: center; gap: 8px; }
    .header-logo { width: 22px; height: 22px; fill: white; }
    .firebase-logo { font-size: 20px; }
    .user-info { display: flex; align-items: center; gap: 8px; }
    .user-details { text-align: right; display: none; }
    @media (min-width: 400px) { .user-details { display: block; } }
    .user-name { font-size: 11px; font-weight: 600; color: white; }
    .user-username { font-size: 9px; color: rgba(255,255,255,0.7); }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); }
    .header-btn { padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: var(--font-main); }

    .container { max-width: 800px; margin: 0 auto; padding: 12px; }

    .card { background: var(--bg-card); border-radius: var(--card-radius); padding: 16px; margin-bottom: 12px; box-shadow: var(--card-shadow); }
    .card h3 { font-size: 14px; margin-bottom: 12px; color: var(--accent); display: flex; align-items: center; gap: 8px; }

    .login-card { max-width: 400px; margin: 30px auto; }
    .login-card ol { font-size: 11px; color: var(--text-secondary); margin: 10px 0 15px 20px; line-height: 1.8; }
    .login-card a { color: var(--accent); }

    .info-box { background: var(--accent-light); padding: 10px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--accent); }

    .input-group { margin-bottom: 12px; }
    .input-group label { display: block; font-size: 11px; font-weight: 600; margin-bottom: 5px; color: var(--text-secondary); }
    .input-group input, .input-group textarea, .input-group select { 
      width: 100%; padding: 10px 12px; background: var(--bg-input); border: 2px solid var(--border); 
      color: var(--text-primary); border-radius: 8px; font-size: 13px; outline: none; font-family: var(--font-main);
    }
    .input-group input:focus, .input-group textarea:focus, .input-group select:focus { border-color: var(--accent); }
    .input-group textarea { min-height: 60px; resize: vertical; }

    .login-btn {
      width: 100%; padding: 12px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; font-family: var(--font-main);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .login-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(255,107,53,0.3); }

    .stats-card { display: flex; justify-content: space-around; background: var(--bg-card); border-radius: var(--card-radius); padding: 15px; margin-bottom: 12px; box-shadow: var(--card-shadow); }
    .stat-item { text-align: center; }
    .stat-value { font-size: 22px; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }

    .sub-tabs { display: flex; background: var(--bg-secondary); border-radius: 10px; padding: 4px; margin-bottom: 12px; }
    .sub-tab { flex: 1; padding: 10px; background: none; border: none; color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.2s; font-family: var(--font-main); }
    .sub-tab.active { background: var(--accent); color: white; }

    .search-bar { display: flex; align-items: center; gap: 8px; background: var(--bg-card); border-radius: 10px; padding: 8px 12px; margin-bottom: 10px; }
    .search-bar svg { width: 18px; height: 18px; color: var(--text-secondary); }
    .search-bar input { flex: 1; background: none; border: none; color: var(--text-primary); font-size: 13px; outline: none; font-family: var(--font-main); }

    .filter-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
    .filter-tab { padding: 6px 12px; background: var(--bg-card); border: none; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 15px; font-family: var(--font-main); }
    .filter-tab.active { background: var(--accent); color: white; }

    /* Collection Selector */
    .collection-selector { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
    .collection-btn { 
      padding: 8px 16px; 
      background: var(--bg-card); 
      border: 2px solid var(--border); 
      color: var(--text-secondary); 
      font-size: 12px; 
      font-weight: 600; 
      cursor: pointer; 
      border-radius: 20px; 
      font-family: var(--font-main);
      transition: all 0.2s;
    }
    .collection-btn.active { 
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); 
      color: white; 
      border-color: var(--accent);
      box-shadow: 0 4px 15px rgba(255,107,53,0.3);
    }
    .collection-btn:hover:not(.active) { border-color: var(--accent); color: var(--accent); }

    .section-title { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }

    .device-grid { display: grid; gap: 10px; }

    .device-card {
      background: var(--bg-card); border-radius: var(--card-radius); padding: 12px; position: relative;
      border-left: var(--card-border); box-shadow: var(--card-shadow); transition: transform 0.2s;
    }
    .device-card:hover { transform: translateX(3px); }
    .device-card.expired { background: var(--bg-card-expired); border-left: var(--expired-border); }
    .device-card.highlight { animation: pulseHighlight 0.5s ease 3; }
    @keyframes pulseHighlight { 0%, 100% { box-shadow: var(--card-shadow); } 50% { box-shadow: 0 0 20px var(--accent); } }

    .position-tag { position: absolute; top: 8px; right: 8px; background: var(--accent); color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 10px; }
    .device-id { font-size: 11px; color: var(--accent); font-weight: 600; margin-bottom: 4px; word-break: break-all; font-family: var(--font-mono); }
    .user-name-card { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
    .key-value { font-size: 12px; font-family: var(--font-mono); background: var(--accent-light); color: var(--accent); padding: 6px 10px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; word-break: break-all; }

    .meta-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
    .expiry-text { color: var(--text-secondary); }
    .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 9px; font-weight: 600; }
    .status-badge.online { background: rgba(39,174,96,0.15); color: var(--success); }
    .status-badge.offline { background: rgba(231,76,60,0.15); color: var(--danger); }

    .expired-badge { position: absolute; bottom: 8px; right: 8px; background: var(--danger); color: white; font-size: 9px; font-weight: 700; padding: 3px 8px; border-radius: 10px; }

    .card-actions { display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
    .action-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .action-btn svg { width: 16px; height: 16px; }
    .action-btn.edit { background: rgba(52,152,219,0.15); color: #3498db; }
    .action-btn.delete { background: rgba(231,76,60,0.15); color: var(--danger); }
    .action-btn.disable { background: rgba(243,156,18,0.15); color: var(--warning); }
    .action-btn:hover { transform: scale(1.05); }

    .json-editor { width: 100%; min-height: 300px; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 8px; padding: 12px; font-family: var(--font-mono); font-size: 11px; color: var(--text-primary); resize: vertical; }
    .json-buttons { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
    .json-buttons button { flex: 1; min-width: 70px; padding: 10px; border: none; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: var(--font-main); }
    .json-buttons .save { background: var(--success); color: white; }
    .json-buttons .format { background: #3498db; color: white; }
    .json-buttons .copy { background: #9b59b6; color: white; }
    .json-buttons .reset { background: #95a5a6; color: white; }

    .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 8px; }
    .status { font-size: 11px; color: var(--text-secondary); }
    .actions { display: flex; gap: 6px; }
    .actions button { padding: 6px 10px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; font-family: var(--font-main); }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card);
      display: flex; justify-content: space-around; align-items: center; padding: 8px 0 12px; border-top: 1px solid var(--border); z-index: 99;
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; color: var(--text-secondary); font-size: 10px; cursor: pointer; padding: 4px 12px; }
    .nav-item.active { color: var(--accent); }
    .nav-item svg { width: 22px; height: 22px; margin-bottom: 2px; }

    .fab-button {
      width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; margin-top: -25px; border: none;
      transition: all 0.3s ease;
    }
    .fab-button svg { width: 24px; height: 24px; color: white; }

    #topBtn {
      position: fixed; right: 12px; bottom: 85px; width: 40px; height: 40px; border-radius: 50%;
      background: var(--bg-card); border: 2px solid var(--border); color: var(--accent); font-size: 18px;
      display: none; align-items: center; justify-content: center; z-index: 98; cursor: pointer;
    }

    .modal-bg {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
      display: none; align-items: flex-start; justify-content: center; padding: 12vh 10px 20px; z-index: 10000; overflow-y: auto;
    }
    .modal-bg.show { display: flex; }
    .modal-box { width: 100%; max-width: 420px; background: var(--bg-card); border-radius: 16px; overflow: visible; }
    .modal-header { padding: 14px 16px; background: var(--header-bg); display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
    .modal-title { font-size: 14px; font-weight: 600; color: white; }
    .modal-close { width: 28px; height: 28px; border-radius: 6px; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 16px; cursor: pointer; }
    .modal-body { padding: 16px; background: var(--bg-card); border-radius: 0 0 16px 16px; }

    .modal-input-group { margin-bottom: 12px; }
    .modal-input-group label { display: block; color: var(--accent); font-weight: 600; margin-bottom: 5px; font-size: 11px; }
    .modal-input { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 2px solid var(--border); color: var(--text-primary); border-radius: 8px; font-size: 13px; outline: none; font-family: var(--font-main); }
    .modal-input:focus { border-color: var(--accent); }
    .modal-row { display: flex; gap: 8px; }
    .modal-row .modal-input-group { flex: 1; }

    .quick-btns { display: flex; gap: 5px; margin-top: 6px; }
    .quick-btn { flex: 1; padding: 8px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; font-family: var(--font-main); }

    .checkbox-label { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-input); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 12px; color: var(--text-primary); }
    .checkbox-label input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent); }

    .modal-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .modal-save-btn { flex: 1; padding: 12px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; font-family: var(--font-main); }
    .modal-save-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .modal-cancel-btn { padding: 12px 16px; background: #666; color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: var(--font-main); }

    .spinner { width: 14px; height: 14px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; margin-right: 6px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; font-weight: 500; opacity: 0; transition: transform 0.3s, opacity 0.3s; z-index: 10001; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    .empty-state { text-align: center; padding: 40px 15px; color: var(--text-secondary); grid-column: 1 / -1; }
    .empty-state p { font-size: 13px; margin-bottom: 12px; }
    .empty-state button { padding: 12px 24px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); border: none; border-radius: 25px; font-weight: 700; color: white; cursor: pointer; font-family: var(--font-main); font-size: 13px; }

    .suggestions { 
      position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-input); border: 2px solid var(--accent); 
      border-radius: 8px; max-height: 150px; overflow-y: auto; z-index: 1000; display: none; margin-top: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .suggestions.show { display: block; }
    .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 12px; color: var(--text-primary); transition: background 0.2s; }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background: var(--accent-light); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Theme Selector */
    .theme-selector { margin-top: 15px; }
    .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
    .theme-option {
      padding: 12px 10px; border-radius: 10px; cursor: pointer; text-align: center; font-size: 11px; font-weight: 600;
      border: 2px solid transparent; transition: all 0.2s;
    }
    .theme-option:hover { transform: scale(1.02); }
    .theme-option.active { border-color: white; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
    .theme-starter { background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; }
    .theme-starter-pro { background: linear-gradient(135deg, #ffc107, #ff9800); color: #111; }
    .theme-starter-max { background: linear-gradient(135deg, #00f5ff, #0080ff); color: #111; }
    .theme-starter-developer { background: linear-gradient(135deg, #00ff41, #00aa2a); color: #111; }
    .theme-firebase { background: linear-gradient(135deg, #ff6b35, #1a1a2e); color: white; }

    /* Warning messages */
    .warning-msg { background: rgba(231,76,60,0.15); color: var(--danger); padding: 8px 12px; border-radius: 6px; font-size: 11px; margin-top: 6px; display: none; }

    /* Modal positioning fix */
    #keyModal.modal-bg { padding: 6vh 16px 20px; }
    #keyModal .modal-body { padding: 16px 20px; }
    #keyModal .modal-input-group { margin-bottom: 14px; }
    #keyModal .modal-row { display: flex; gap: 12px; }
    #keyModal .modal-row .modal-input-group { flex: 1; }
    #keyModal .expiry-inline { display: flex; align-items: center; gap: 8px; }
    #keyModal .expiry-inline .modal-input { flex: 2.2; }
    #keyModal .expiry-inline .quick-btn { flex: 1; height: 42px; }
    #keyModal label.checkbox-label, #keyModal label.inline-checkbox { display: flex; align-items: center; justify-content: flex-start; height: 42px; padding: 0 12px; gap: 10px; box-sizing: border-box; }
    #keyModal label.checkbox-label input[type="checkbox"] { margin: 0; align-self: center; }
    #keyModal .modal-buttons { display: flex; gap: 12px; margin-top: 16px; }
    #keyModal .modal-save-btn { flex: 2; height: 46px; }
    #keyModal .modal-cancel-btn { flex: 1; height: 46px; }
    #keyModal .modal-box { width: 100%; max-width: 420px; margin: 0 auto; }
    #keyModal.modal-bg { padding-top: 6vh !important; padding-left: 30px !important; padding-right: 30px !important; padding-bottom: 20px !important; }
    #keyModal .modal-body { padding: 12px 18px !important; }
    #keyModal .modal-input-group { margin-bottom: 10px !important; }
    #keyModal .modal-input { padding: 8px 10px !important; font-size: 12px !important; }
    #keyModal .expiry-inline .quick-btn, #keyModal .modal-save-btn, #keyModal .modal-cancel-btn { height: 38px !important; }
    #keyModal label.checkbox-label { height: 38px !important; padding: 0 10px !important; }
    #keyModal .modal-buttons { margin-top: 10px !important; }

    /* Connection status */
    .connection-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 10px;
      font-weight: 600;
    }
    .connection-status.connected { background: rgba(39,174,96,0.15); color: var(--success); }
    .connection-status.disconnected { background: rgba(231,76,60,0.15); color: var(--danger); }
    .connection-dot { width: 8px; height: 8px; border-radius: 50%; }
    .connection-status.connected .connection-dot { background: var(--success); animation: pulse 2s infinite; }
    .connection-status.disconnected .connection-dot { background: var(--danger); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body data-theme="starter">

  <div class="header">
    <h1>
      <span class="firebase-logo">üî•</span>
      Firebase Admin Panel
    </h1>
    <div class="user-info" id="userInfo" style="display:none;">
      <div class="connection-status connected" id="connectionStatus">
        <span class="connection-dot"></span>
        <span>Connected</span>
      </div>
      <button class="header-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="container">
    <div id="loginSection">
      <div class="card login-card">
        <h3>üî• Firebase Connection</h3>
        <div class="info-box">
          <p style="margin:0;font-size:11px;"><strong>‚úÖ Auto-Connected to Firebase</strong></p>
          <p style="margin:5px 0 0;font-size:10px;color:var(--text-secondary);">Database: opjat-2005</p>
        </div>
        <button class="login-btn" id="connectBtn">üöÄ Connect to Firebase</button>
      </div>
    </div>

    <div id="mainPanel" style="display:none;">
      <div class="tab-content active" id="tab-devices">
        <!-- Collection Selector -->
        <div class="section-title">üìÅ Select Collection</div>
        <div class="collection-selector" id="collectionSelector">
          <button class="collection-btn active" data-collection="Camera">üì∑ Camera</button>
          <button class="collection-btn" data-collection="Gallery">üñºÔ∏è Gallery</button>
          <button class="collection-btn" data-collection="KycRndm">üîê KycRndm</button>
        </div>

        <div class="stats-card">
          <div class="stat-item"><div class="stat-value" id="totalCount">0</div><div class="stat-label">Total</div></div>
          <div class="stat-item"><div class="stat-value" id="activeCount">0</div><div class="stat-label">Active</div></div>
          <div class="stat-item"><div class="stat-value" id="expiredCount">0</div><div class="stat-label">Expired</div></div>
        </div>

        <div class="sub-tabs">
          <button class="sub-tab active" data-subtab="keys">üîë Keys</button>
          <button class="sub-tab" data-subtab="editor">üìù JSON</button>
        </div>

        <div class="tab-content active" id="subtab-keys">
          <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input type="text" placeholder="Search devices..." id="searchInput">
          </div>
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">üìú All</button>
            <button class="filter-tab" data-filter="active">‚úÖ Active</button>
            <button class="filter-tab" data-filter="expired">‚ö†Ô∏è Expired</button>
          </div>
          <div class="section-title">Device Keys <span id="positionInfo" style="font-weight:normal;">(Total: 0 keys)</span></div>
          <div id="dataList" class="device-grid"></div>
        </div>

        <div class="tab-content" id="subtab-editor">
          <textarea class="json-editor" id="rawJsonEditor" placeholder="JSON data..."></textarea>
          <div class="json-buttons">
            <button class="save" id="updateFromJsonBtn">üì§ Save</button>
            <button class="format" id="formatJsonBtn">‚ú® Format</button>
            <button class="copy" id="copyJsonBtn">üìã Copy</button>
            <button class="reset" id="resetJsonBtn">üîÑ Reset</button>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-settings">
        <div class="card">
          <h3>üî• Firebase Status</h3>
          <div class="status-bar">
            <div class="status" id="firebaseStatus">‚ö° Connected</div>
            <div class="actions">
              <button id="refreshDataBtn">üîÑ Refresh</button>
            </div>
          </div>
          <div class="info-box" style="margin-top:10px;">
            <p style="margin:0;font-size:11px;"><strong>Database URL:</strong></p>
            <p style="margin:5px 0 0;font-size:10px;word-break:break-all;color:var(--text-secondary);">
              https://opjat-2005-default-rtdb.asia-southeast1.firebasedatabase.app
            </p>
          </div>
        </div>

        <div class="card theme-selector">
          <h3>üé® Select Theme</h3>
          <div class="theme-grid">
            <div class="theme-option theme-starter active" data-theme="starter">üî• Firebase</div>
            <div class="theme-option theme-starter-pro" data-theme="starter-pro">üåü Pro Gold</div>
            <div class="theme-option theme-starter-max" data-theme="starter-max">‚ö° Cyber</div>
            <div class="theme-option theme-starter-developer" data-theme="starter-developer">üíª Matrix</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" id="bottomNav" style="display:none;">
    <div class="nav-item active" id="navDevices" onclick="switchToTab('devices')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      Devices
    </div>
    <button class="fab-button" onclick="openKeyModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>
    <div class="nav-item" id="navSettings" onclick="switchToTab('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </div>
  </div>

  <button id="topBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë</button>

  <!-- Add/Edit Key Modal -->
  <div class="modal-bg" id="keyModal">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">‚ûï Add New License Key</div>
        <button class="modal-close" onclick="closeKeyModal()">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Device ID -->
        <div class="modal-input-group">
          <label>üì± Device ID</label>
          <input id="deviceId" placeholder="Device ID" type="text" class="modal-input" oninput="checkDeviceIdDuplicate()" />
          <div class="warning-msg" id="deviceIdWarning">‚ö†Ô∏è Device ID already exists! Will update existing entry.</div>
        </div>

        <!-- Key + Generate -->
        <div class="modal-input-group">
          <label>üîë License Key</label>
          <div style="display:flex;gap:6px;">
            <input id="key" placeholder="License key" type="text" class="modal-input" style="flex:1;" oninput="checkKeyDuplicate()" />
            <button class="quick-btn" onclick="generateRandomKey()" style="flex:0 0 70px;">üé≤ Gen</button>
          </div>
          <div class="warning-msg" id="keyWarning">‚ö†Ô∏è This key already exists! Please generate a new one.</div>
        </div>

        <!-- Expiry + Quick buttons -->
        <div class="modal-input-group">
          <label>üìÖ Expiry Date</label>
          <div class="expiry-inline">
            <input id="expiry" placeholder="dd-mm-yyyy" type="text" class="modal-input" />
            <button class="quick-btn" onclick="setQuickDate(7)">7d</button>
            <button class="quick-btn" onclick="setQuickDate(15)">15d</button>
            <button class="quick-btn" onclick="setQuickDate(30)">30d</button>
          </div>
        </div>

        <div class="modal-input-group">
          <div class="expiry-inline">
            <button class="quick-btn" onclick="adjustExpiry(-1)">‚àí1</button>
            <button class="quick-btn" onclick="adjustExpiry(1)">+1</button>
            <label class="checkbox-label inline-checkbox">
              <input id="allowOffline" type="checkbox" />
              <span>‚úì Allow Offline</span>
            </label>
          </div>
        </div>

        <!-- User + Position -->
        <div class="modal-row">
          <div class="modal-input-group" style="position:relative;">
            <label>üë§ User Name</label>
            <input id="username" placeholder="User name" type="text" class="modal-input" autocomplete="off" />
            <div id="userSuggestions" class="suggestions"></div>
          </div>
          <div class="modal-input-group" style="position:relative;">
            <label>üìç Position</label>
            <input id="positionInput" placeholder="#" type="text" class="modal-input" autocomplete="off" />
            <div id="positionSuggestions" class="suggestions"></div>
          </div>
        </div>

        <span id="positionInfoModal" style="display:block;margin:6px 0;color:var(--text-secondary);font-size:10px;">(Total: 0 keys)</span>

        <!-- Buttons -->
        <div class="modal-buttons">
          <button class="modal-save-btn" id="saveBtn">üî• Save to Firebase</button>
          <button class="modal-cancel-btn" onclick="closeKeyModal()">‚úï Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copied!</div>

  <!-- Saved Card Popup -->
  <div class="modal-bg" id="savedCardModal">
    <div class="modal-box" style="max-width:340px;">
      <div class="modal-header">
        <div class="modal-title" id="savedCardTitle">‚úÖ Key Saved!</div>
        <button class="modal-close" onclick="closeSavedCardModal()">√ó</button>
      </div>
      <div class="modal-body" style="padding:12px;">
        <div id="savedCardPreview"></div>
        <button class="modal-save-btn" onclick="closeSavedCardModal()" style="margin-top:12px; width:100%">üëç OK</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA1FIDLD-AKVlEz-AJiweYVdxhIP0Rnijk",
      authDomain: "opjat-2005.firebaseapp.com",
      databaseURL: "https://opjat-2005-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "opjat-2005",
      storageBucket: "opjat-2005.firebasestorage.app",
      messagingSenderId: "2500552965",
      appId: "1:2500552965:web:4f6664a366967a2525af6c"
    };

    // Initialize Firebase
    let app, database;
    let currentCollection = 'Camera';
    let currentData = [];
    let allDataArray = [];
    let currentUpdateId = null;
    let currentFilter = 'all';

    function showToast(msg) { 
      const t = document.getElementById('toast'); 
      t.textContent = msg; 
      t.classList.add('show'); 
      setTimeout(() => t.classList.remove('show'), 2000); 
    }

    function isExpired(dateStr) {
      if (!dateStr) return false;
      const parts = dateStr.split('-');
      if (parts.length !== 3) return false;
      const expDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
      return expDate < new Date();
    }

    function formatDate(d) { 
      return String(d.getDate()).padStart(2,'0') + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + d.getFullYear(); 
    }

    window.setQuickDate = function(days) { 
      const d = new Date(); 
      d.setDate(d.getDate() + days); 
      document.getElementById('expiry').value = formatDate(d); 
    }

    window.adjustExpiry = function(days) { 
      const input = document.getElementById('expiry'); 
      if (!input.value) return; 
      const parts = input.value.split('-'); 
      if (parts.length !== 3) return; 
      const d = new Date(parseInt(parts[2]), parseInt(parts[1])-1, parseInt(parts[0])); 
      if (isNaN(d.getTime())) return; 
      d.setDate(d.getDate() + days); 
      input.value = formatDate(d); 
    }

    window.generateRandomKey = function() { 
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; 
      const existing = allDataArray.map(x => x.key); 
      let key = ""; 
      const lens = [11, 12, 13]; 
      do { 
        const len = lens[Math.floor(Math.random() * lens.length)]; 
        key = ""; 
        for (let i = 0; i < len; i++) key += chars.charAt(Math.floor(Math.random() * chars.length)); 
      } while (existing.includes(key)); 
      document.getElementById('key').value = key; 
      checkKeyDuplicate(); 
    }

    function checkDeviceIdDuplicate() {
      const deviceId = document.getElementById('deviceId').value.trim();
      const warning = document.getElementById('deviceIdWarning');
      if (!deviceId || currentUpdateId) { warning.style.display = 'none'; return; }
      const exists = allDataArray.find(i => (i.device_id || i.id) === deviceId);
      if (exists) { warning.style.display = 'block'; } 
      else { warning.style.display = 'none'; }
    }

    function checkKeyDuplicate() {
      const key = document.getElementById('key').value.trim();
      const warning = document.getElementById('keyWarning');
      if (!key) { warning.style.display = 'none'; return false; }
      
      let originalKey = null;
      if (currentUpdateId) {
        const originalItem = allDataArray.find(i => (i.device_id || i.id) === currentUpdateId);
        if (originalItem) originalKey = originalItem.key;
      }
      
      const exists = allDataArray.find(i => {
        const itemId = i.device_id || i.id;
        const isSameItem = currentUpdateId && itemId === currentUpdateId;
        return i.key === key && !isSameItem;
      });
      
      if (currentUpdateId && key === originalKey) {
        warning.style.display = 'none';
        return false;
      }
      
      if (exists) { warning.style.display = 'block'; return true; } 
      else { warning.style.display = 'none'; return false; }
    }

    window.copyKey = function(key) { 
      navigator.clipboard.writeText(key); 
      showToast('‚úÖ Key copied!'); 
    }

    function scrollToElement(el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function highlightElement(el) {
      el.classList.add('highlight');
      setTimeout(() => el.classList.remove('highlight'), 1500);
    }

    function openKeyModal() {
      currentUpdateId = null;
      document.getElementById('deviceId').value = '';
      document.getElementById('key').value = '';
      document.getElementById('expiry').value = '';
      document.getElementById('username').value = '';
      document.getElementById('allowOffline').checked = false;
      document.getElementById('positionInput').value = allDataArray.length + 1;
      document.getElementById('modalTitle').innerHTML = '‚ûï Add New License Key';
      document.getElementById('deviceIdWarning').style.display = 'none';
      document.getElementById('keyWarning').style.display = 'none';
      document.getElementById('positionInfoModal').textContent = `(Total: ${allDataArray.length} keys)`;
      document.getElementById('keyModal').classList.add('show');
    }

    function closeKeyModal() {
      document.getElementById('keyModal').classList.remove('show');
    }

    function switchToTab(tab) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');
      document.getElementById(`nav${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
    }

    // Firebase Functions
    async function connectToFirebase() {
      try {
        document.getElementById('connectBtn').innerHTML = '<span class="spinner"></span> Connecting...';
        document.getElementById('connectBtn').disabled = true;

        app = firebase.initializeApp(firebaseConfig);
        database = firebase.database();

        // Test connection
        const testRef = database.ref('.info/connected');
        testRef.on('value', (snapshot) => {
          if (snapshot.val() === true) {
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionStatus').innerHTML = '<span class="connection-dot"></span><span>Connected</span>';
          } else {
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionStatus').innerHTML = '<span class="connection-dot"></span><span>Disconnected</span>';
          }
        });

        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainPanel').style.display = 'block';
        document.getElementById('bottomNav').style.display = 'flex';
        document.getElementById('userInfo').style.display = 'flex';

        // Load default collection
        await loadCollectionData();
        showToast('üî• Firebase Connected!');

      } catch (error) {
        console.error('Firebase connection error:', error);
        alert('‚ùå Connection failed: ' + error.message);
        document.getElementById('connectBtn').innerHTML = 'üöÄ Connect to Firebase';
        document.getElementById('connectBtn').disabled = false;
      }
    }

    async function loadCollectionData() {
      try {
        document.getElementById('firebaseStatus').innerHTML = 'üîÑ Loading...';
        
        const collectionRef = database.ref(currentCollection);
        const snapshot = await collectionRef.once('value');
        const data = snapshot.val();

        if (data && Array.isArray(data)) {
          currentData = data.filter(item => item !== null);
        } else if (data && typeof data === 'object') {
          currentData = Object.keys(data).map(k => ({ id: k, ...data[k] }));
        } else {
          currentData = [];
        }

        allDataArray = currentData;
        displayData();
        document.getElementById('rawJsonEditor').value = JSON.stringify(currentData, null, 2);
        document.getElementById('firebaseStatus').innerHTML = '‚úÖ Loaded';

        // Set up realtime listener
        collectionRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && Array.isArray(data)) {
            currentData = data.filter(item => item !== null);
          } else if (data && typeof data === 'object') {
            currentData = Object.keys(data).map(k => ({ id: k, ...data[k] }));
          } else {
            currentData = [];
          }
          allDataArray = currentData;
          displayData();
          document.getElementById('rawJsonEditor').value = JSON.stringify(currentData, null, 2);
        });

      } catch (error) {
        console.error('Load error:', error);
        document.getElementById('firebaseStatus').innerHTML = '‚ùå Error';
        showToast('‚ùå Load failed!');
      }
    }

    async function saveDataToFirebase(msg = 'Update') {
      try {
        document.getElementById('firebaseStatus').innerHTML = 'üì§ Saving...';
        
        const collectionRef = database.ref(currentCollection);
        await collectionRef.set(currentData);
        
        document.getElementById('firebaseStatus').innerHTML = '‚úÖ Saved';
        return true;
      } catch (error) {
        console.error('Save error:', error);
        alert('‚ùå Save failed: ' + error.message);
        document.getElementById('firebaseStatus').innerHTML = '‚ùå Error';
        return false;
      }
    }

    function displayData(searchTerm = '', highlightId = null) {
      const list = document.getElementById('dataList');
      list.innerHTML = '';

      let total = allDataArray.length, active = 0, expired = 0;
      allDataArray.forEach(i => { if (isExpired(i.expirydate)) expired++; else active++; });

      document.getElementById('totalCount').textContent = total;
      document.getElementById('activeCount').textContent = active;
      document.getElementById('expiredCount').textContent = expired;
      document.getElementById('positionInfo').textContent = `(Total: ${total} keys)`;

      let filtered = allDataArray;
      if (currentFilter === 'active') filtered = allDataArray.filter(i => !isExpired(i.expirydate));
      else if (currentFilter === 'expired') filtered = allDataArray.filter(i => isExpired(i.expirydate));

      if (searchTerm) {
        const s = searchTerm.toLowerCase();
        filtered = filtered.filter(i => {
          const did = (i.device_id || i.id || '').toLowerCase();
          const user = (i.user || '').toLowerCase();
          const key = (i.key || '').toLowerCase();
          return did.includes(s) || user.includes(s) || key.includes(s);
        });
      }

      if (!filtered.length) {
        list.innerHTML = `<div class="empty-state"><p>No keys found</p><button onclick="openKeyModal()">‚ûï Add New Key</button></div>`;
        return;
      }

      filtered.forEach((item) => {
        const deviceId = item.device_id || item.id || 'Unknown';
        const exp = isExpired(item.expirydate);
        const pos = allDataArray.findIndex(d => (d.device_id || d.id) === deviceId) + 1;

        const div = document.createElement('div');
        div.className = 'device-card' + (exp ? ' expired' : '');
        div.id = `card-${deviceId}`;
        div.innerHTML = `
          <div class="position-tag">#${pos}</div>
          <div class="device-id">${deviceId}</div>
          <div class="user-name-card">${item.user || 'N/A'}</div>
          <div class="key-value" onclick="copyKey('${item.key || ''}')">${item.key || 'N/A'}</div>
          <div class="meta-row">
            <span class="expiry-text">${item.expirydate || 'N/A'}</span>
            <span class="status-badge ${item.Allowoffline ? 'offline' : 'online'}">${item.Allowoffline ? 'Offline' : 'Online'}</span>
          </div>
          ${exp ? '<div class="expired-badge">‚ö†Ô∏è EXPIRED</div>' : ''}
          <div class="card-actions">
            <button class="action-btn edit" onclick="updateItem('${deviceId}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            <button class="action-btn delete" onclick="deleteItem('${deviceId}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
            <button class="action-btn disable" onclick="disableItem('${deviceId}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
            </button>
          </div>`;
        list.appendChild(div);

        if (highlightId && deviceId === highlightId) {
          setTimeout(() => { scrollToElement(div); highlightElement(div); }, 100);
        }
      });
    }

    window.updateItem = function(id) {
      currentUpdateId = id;
      let item = currentData.find(e => (e.device_id || e.id) === id);
      if (item) {
        document.getElementById('deviceId').value = item.device_id || id;
        document.getElementById('key').value = item.key || '';
        document.getElementById('expiry').value = item.expirydate || '';
        document.getElementById('username').value = item.user || '';
        document.getElementById('allowOffline').checked = item.Allowoffline || false;
        document.getElementById('positionInput').value = allDataArray.findIndex(x => (x.device_id || x.id) === id) + 1;
        document.getElementById('modalTitle').innerHTML = '‚úèÔ∏è Update License Key';
        document.getElementById('deviceIdWarning').style.display = 'none';
        document.getElementById('keyWarning').style.display = 'none';
        document.getElementById('positionInfoModal').textContent = `(Total: ${allDataArray.length} keys)`;
        document.getElementById('keyModal').classList.add('show');
      }
    }

    window.deleteItem = async function(id) {
      if (confirm(`Delete key for ${id}?`)) {
        const idx = currentData.findIndex(i => (i.device_id || i.id) === id);
        if (idx !== -1) currentData.splice(idx, 1);
        
        if (await saveDataToFirebase(`Delete ${id}`)) {
          allDataArray = currentData;
          displayData();
          document.getElementById('rawJsonEditor').value = JSON.stringify(currentData, null, 2);
          showToast('üóë Deleted!');
        }
      }
    }

    window.disableItem = async function(id) {
      if (confirm(`Disable key for ${id}?`)) {
        const idx = currentData.findIndex(i => (i.device_id || i.id) === id);
        if (idx !== -1) {
          const parts = (currentData[idx].expirydate || '01-01-2026').split('-');
          currentData[idx].expirydate = `${parts[0]}-${parts[1]}-2020`;
          
          if (await saveDataToFirebase(`Disable ${id}`)) {
            allDataArray = currentData;
            displayData('', id);
            document.getElementById('rawJsonEditor').value = JSON.stringify(currentData, null, 2);
            showToast('üö´ Disabled!');
          }
        }
      }
    }

    function showSavedCard(deviceId, isUpdate) {
      const item = allDataArray.find(i => (i.device_id || i.id) === deviceId);
      if (!item) return;
      const exp = isExpired(item.expirydate);
      const pos = allDataArray.findIndex(d => (d.device_id || d.id) === deviceId) + 1;

      document.getElementById('savedCardTitle').innerHTML = isUpdate ? '‚úÖ Key Updated!' : '‚úÖ Key Added!';
      document.getElementById('savedCardPreview').innerHTML = `
        <div class="device-card ${exp ? 'expired' : ''}" style="margin:0;position:relative;">
          <div class="position-tag">#${pos}</div>
          <div class="device-id">${item.device_id || deviceId}</div>
          <div class="user-name-card">${item.user || 'N/A'}</div>
          <div class="key-value" onclick="copyKey('${item.key || ''}')">${item.key || 'N/A'}</div>
          <div class="meta-row">
            <span class="expiry-text">${item.expirydate || 'N/A'}</span>
            <span class="status-badge ${item.Allowoffline ? 'offline' : 'online'}">${item.Allowoffline ? 'Offline' : 'Online'}</span>
          </div>
          ${exp ? '<div class="expired-badge">‚ö†Ô∏è EXPIRED</div>' : ''}
        </div>`;
      document.getElementById('savedCardModal').classList.add('show');
    }

    window.closeSavedCardModal = function() {
      document.getElementById('savedCardModal').classList.remove('show');
      const preview = document.getElementById('savedCardPreview');
      const deviceIdEl = preview.querySelector('.device-id');
      if (deviceIdEl) {
        const deviceId = deviceIdEl.textContent;
        const card = document.getElementById(`card-${deviceId}`);
        if (card) {
          setTimeout(() => { scrollToElement(card); highlightElement(card); }, 100);
        }
      }
    }

    // Event Listeners
    document.getElementById('connectBtn').addEventListener('click', connectToFirebase);

    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('Logout?')) {
        location.reload();
      }
    });

    // Collection selector
    document.querySelectorAll('.collection-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        document.querySelectorAll('.collection-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCollection = btn.dataset.collection;
        await loadCollectionData();
        showToast(`üìÅ Loaded ${currentCollection}`);
      });
    });

    // Save button
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const btn = document.getElementById('saveBtn');
      const id = document.getElementById('deviceId').value.trim();
      const key = document.getElementById('key').value.trim();
      const expiry = document.getElementById('expiry').value.trim();
      const user = document.getElementById('username').value.trim();
      const allow = document.getElementById('allowOffline').checked;
      const posVal = document.getElementById('positionInput').value.trim();

      if (!id || !key || !expiry || !user) { alert('‚ö†Ô∏è Fill all fields!'); return; }
      if (checkKeyDuplicate()) { return; }

      let pos = parseInt(posVal);
      if (!pos || pos < 1 || pos > allDataArray.length + 1) { alert('‚ö†Ô∏è Invalid position!'); return; }

      btn.disabled = true;
      const orig = btn.innerHTML;
      btn.innerHTML = '<span class="spinner"></span> Saving...';

      const entry = { device_id: id, key, expirydate: expiry, user, Allowoffline: allow };
      let arr = [...allDataArray];

      if (currentUpdateId) {
        const idx = arr.findIndex(i => (i.device_id || i.id) === currentUpdateId);
        if (idx !== -1) arr.splice(idx, 1);
      }

      arr.splice(pos - 1, 0, entry);
      currentData = arr;

      const msg = currentUpdateId ? `Update ${id}` : `Add ${id}`;
      const wasUpdate = !!currentUpdateId;
      const result = await saveDataToFirebase(msg);

      btn.disabled = false;
      btn.innerHTML = orig;

      if (result) {
        document.getElementById('searchInput').value = '';
        allDataArray = currentData;
        displayData('', null);
        document.getElementById('rawJsonEditor').value = JSON.stringify(currentData, null, 2);
        currentUpdateId = null;
        closeKeyModal();
        showSavedCard(id, wasUpdate);
      }
    });

    // Search
    document.getElementById('searchInput').addEventListener('input', (e) => displayData(e.target.value));

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        displayData(document.getElementById('searchInput').value);
      });
    });

    // Sub tabs
    document.querySelectorAll('.sub-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#tab-devices > .tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`subtab-${tab.dataset.subtab}`).classList.add('active');
      });
    });

    // JSON Editor buttons
    document.getElementById('updateFromJsonBtn').addEventListener('click', async () => {
      try {
        const parsed = JSON.parse(document.getElementById('rawJsonEditor').value.trim());
        if (confirm('Save JSON to Firebase?')) {
          currentData = parsed;
          if (await saveDataToFirebase('JSON Update')) {
            allDataArray = currentData;
            displayData();
            showToast('‚úÖ Saved!');
          }
        }
      } catch (e) { alert('‚ùå Invalid JSON!'); }
    });

    document.getElementById('formatJsonBtn').addEventListener('click', () => {
      try {
        document.getElementById('rawJsonEditor').value = JSON.stringify(JSON.parse(document.getElementById('rawJsonEditor').value.trim()), null, 2);
        showToast('‚ú® Formatted!');
      } catch (e) { alert('‚ùå Invalid JSON!'); }
    });

    document.getElementById('copyJsonBtn').addEventListener('click', () => {
      document.getElementById('rawJsonEditor').select();
      document.execCommand('copy');
      showToast('üìã Copied!');
    });

    document.getElementById('resetJsonBtn').addEventListener('click', () => {
      if (confirm('Reset?')) {
        document.getElementById('rawJsonEditor').value = JSON.stringify(currentData, null, 2);
        showToast('üîÑ Reset!');
      }
    });

    // Refresh button
    document.getElementById('refreshDataBtn').addEventListener('click', async () => {
      await loadCollectionData();
      showToast('üîÑ Refreshed!');
    });

    // Theme selector
    document.querySelectorAll('.theme-option').forEach(opt => {
      opt.addEventListener('click', () => {
        document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
        opt.classList.add('active');
        document.body.setAttribute('data-theme', opt.dataset.theme);
        localStorage.setItem('firebase_theme', opt.dataset.theme);
      });
    });

    // User suggestions
    document.getElementById('username').addEventListener('input', function() {
      const v = this.value.toLowerCase();
      const sug = document.getElementById('userSuggestions');
      sug.innerHTML = '';
      if (!v) { sug.classList.remove('show'); return; }
      const matches = [...new Set(allDataArray.map(x => x.user).filter(u => u && u.toLowerCase().includes(v)))].slice(0, 5);
      if (!matches.length) { sug.classList.remove('show'); return; }
      matches.forEach(name => {
        const d = document.createElement('div');
        d.className = 'suggestion-item';
        d.textContent = name;
        d.onclick = () => { document.getElementById('username').value = name; sug.classList.remove('show'); };
        sug.appendChild(d);
      });
      sug.classList.add('show');
    });

    // Position suggestions
    document.getElementById('positionInput').addEventListener('input', function() {
      const v = this.value.toLowerCase();
      const sug = document.getElementById('positionSuggestions');
      sug.innerHTML = '';
      if (!v || /^\d+$/.test(v)) { sug.classList.remove('show'); return; }
      const matches = allDataArray.filter(i => (i.user || '').toLowerCase().includes(v)).slice(0, 5);
      if (!matches.length) { sug.classList.remove('show'); return; }
      matches.forEach(i => {
        const did = i.device_id || i.id;
        const pos = allDataArray.findIndex(d => (d.device_id || d.id) === did) + 1;
        const d = document.createElement('div');
        d.className = 'suggestion-item';
        d.innerHTML = `<strong>#${pos}</strong> - ${i.user || 'N/A'}`;
        d.onclick = () => { document.getElementById('positionInput').value = pos; sug.classList.remove('show'); };
        sug.appendChild(d);
      });
      sug.classList.add('show');
    });

    document.addEventListener('click', (e) => {
      if (!document.getElementById('username').contains(e.target)) document.getElementById('userSuggestions').classList.remove('show');
      if (!document.getElementById('positionInput').contains(e.target)) document.getElementById('positionSuggestions').classList.remove('show');
    });

    // Scroll to top button
    window.addEventListener('scroll', () => {
      document.getElementById('topBtn').style.display = window.scrollY > 200 ? 'flex' : 'none';
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('firebase_theme');
    if (savedTheme) {
      document.body.setAttribute('data-theme', savedTheme);
      document.querySelectorAll('.theme-option').forEach(o => {
        o.classList.toggle('active', o.dataset.theme === savedTheme);
      });
    }
  </script>
</body>
</html>
